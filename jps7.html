<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jejak Petualang Siroh App</title>
    <!-- Load Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ikon Lucide (Pastikan ini dimuat sebelum skrip utama) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Import Font Quicksand */
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');
        html, body {
            font-family: 'Quicksand', sans-serif;
        }
        /* Style untuk body agar app center di desktop */
        body {
            display: flex;
            justify-content: center;
            min-height: 100vh;
            background-color: #e5e7eb;
        }
        #app-container {
            /* Diubah dari 420px menjadi 512px (max-w-lg) untuk keselarasan */
            max-width: 512px; 
            width: 100%;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        /* Sembunyikan default input type file */
        input[type="file"]::file-selector-button {
            display: none;
        }
        /* Jaga agar placeholder ikon tetap terlihat sebelum di-render */
        [data-lucide] {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="relative min-h-screen">
        <!-- Konten Aplikasi akan di-render di sini -->
    </div>

    <!-- Firebase Imports (PENTING) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Perbarui impor Firebase untuk memastikan signInWithEmailAndPassword dihapus jika tidak digunakan,
        // tetapi untuk menjaga fleksibilitas, kita biarkan saja, namun signInWithEmailAndPassword tidak digunakan lagi
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, doc, updateDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- KONSTANTA DAN INISIALISASI VARIABEL GLOBAL ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Coba parse konfigurasi Firebase yang disediakan oleh lingkungan
        let configProvided = false;
        try {
            const tempConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (Object.keys(tempConfig).length > 0 && tempConfig.projectId) {
                configProvided = true;
            }
        } catch (e) {
            console.error("Failed to parse firebase config:", e);
        }
        
        // Jika tidak ada konfigurasi dari lingkungan, gunakan konfigurasi minimal (ini akan gagal jika tidak diganti)
        // PENTING: Jika Anda menjalankan di luar editor ini, GANTI BARIS BERIKUT dengan config Anda
        const firebaseConfig = configProvided ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB-PEhn-X7L4UOpGLQmsJA3lhMgKlVbrF0",
            authDomain: "jejakpetualangsiroh.firebaseapp.com",
            projectId: "jejakpetualangsiroh",
            storageBucket: "jejakpetualangsiroh.firebasestorage.app",
            messagingSenderId: "177539566756",
            appId: "1:177539566756:web:1a863dcd05c1395201ea31"
        };
        
        // Inisialisasi Firebase hanya jika configProvided, atau jika config default berhasil di set
        let app, auth, db;
        let isFirebaseInitialized = false;

        try {
             app = initializeApp(firebaseConfig);
             auth = getAuth(app);
             db = getFirestore(app);
             isFirebaseInitialized = true;
        } catch (error) {
            // Ini akan terjadi jika config DUMMY di atas gagal atau project-ID tidak valid
            console.warn("Firebase initialization failed. Running in UI-only mode.", error);
            isFirebaseInitialized = false;
        }


        const BASE_TICKET_PRICE = 150000;
        const EXTRA_COMPANION_PRICE = 20000;
        const EXTRA_LUNCH_PRICE = 25000;
        const MAX_FILE_SIZE_KB = 500;
        const SETTINGS_COLLECTION_PATH = `artifacts/${appId}/public/data/settings`;
        const FORM_STATUS_DOC_ID = 'form_status';
        const PARTICIPANTS_COLLECTION_PATH = `artifacts/${appId}/public/data/participants`;

        // --- GLOBAL STATE ---
        let currentPage = 'landing';
        let currentUser = null;
        let isAuthReady = false;
        let isFormOpen = true;
        let registrations = [];
        let tempAdminError = null;

        // --- PERBAIKAN: FORM DATA DIPINDAH KE GLOBAL STATE ---
        // Ini memastikan data tidak hilang saat re-render terjadi
        let globalRegistrationFormData = {
            guardianName: '', whatsappNumber: '', numChildren: 1, 
            numExtraCompanions: 0, numExtraLunch: 0,
            childrenData: [{ name: '', gender: 'Laki-laki', age: '' }],
            proofOfTransfer: null, proofOfTransferDataUrl: null,
        };
        
        // Listener Variables - akan diisi di onAuthStateChanged
        let unsubscribeRegistrations = null; 
        let unsubscribeSettings = null;

        // --- UTILITY FUNCTIONS ---
        
        const resetGlobalFormData = () => {
            globalRegistrationFormData = {
                guardianName: '', whatsappNumber: '', numChildren: 1, 
                numExtraCompanions: 0, numExtraLunch: 0,
                childrenData: [{ name: '', gender: 'Laki-laki', age: '' }],
                proofOfTransfer: null, proofOfTransferDataUrl: null,
            };
        };

        const formatRupiah = (amount) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        const fileToDataUrl = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        const navigate = (page) => {
            window.scrollTo(0, 0);
            currentPage = page;
            renderApp();
        };

        const setAdminError = (message) => {
            tempAdminError = message;
            // Re-render hanya bagian dashboard untuk menampilkan error
            const errorDisplay = document.getElementById('admin-error-display');
            if (currentPage === 'admin-dashboard' && errorDisplay) {
                errorDisplay.innerHTML = message ? `
                    <div class="p-3 bg-red-50 rounded-xl border-2 border-red-400 text-red-700 font-bold text-sm text-center animate-pulse">
                        ${icon('AlertTriangle', 18)}
                        ${message}
                    </div>
                ` : '';
                renderIcons();
            }
            if (message) setTimeout(() => setAdminError(null), 5000);
        };
        
        // FUNGSI IKON BARU: Hanya menaruh placeholder yang akan diubah oleh Lucide
        const icon = (name, size = 24, className = "") => {
            // Lucide akan mencari tag dengan atribut data-lucide
            return `<span data-lucide="${name}" data-lucide-size="${size}" class="${className}" style="display:inline-block;"></span>`;
        };

        // FUNGSI UNTUK MERENDER IKON SETELAH HTML DIMUAT
        const renderIcons = () => {
            // Memastikan library Lucide ada di global scope
            if (typeof window.lucide !== 'undefined' && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        };

        // --- FIREBASE LOGIC & LISTENERS ---

        // 1. Authentication
        const initAuth = async () => {
            if (!isFirebaseInitialized) {
                isAuthReady = true; // Langsung siap, tetapi tanpa Firebase
                renderApp();
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Ini memastikan ada current user (anonymous) saat refresh
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };
        initAuth();

        if (isFirebaseInitialized) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                isAuthReady = true;
                
                // Reset listeners jika ada
                if (unsubscribeRegistrations) unsubscribeRegistrations();
                if (unsubscribeSettings) unsubscribeSettings();

                if (currentUser) {
                    // 1. Form Status Listener (Sekarang di dalam onAuthStateChanged)
                    const settingsDocRef = doc(db, SETTINGS_COLLECTION_PATH, FORM_STATUS_DOC_ID);
                    unsubscribeSettings = onSnapshot(settingsDocRef, async (docSnap) => {
                        if (docSnap.exists()) {
                            isFormOpen = docSnap.data().isOpen;
                        } else {
                            try {
                                await setDoc(settingsDocRef, { isOpen: true, lastUpdated: serverTimestamp() });
                                isFormOpen = true;
                            } catch (error) {
                                console.log("Settings doc not found, defaulting to Open.");
                                isFormOpen = true;
                            }
                        }
                        if (currentPage === 'landing' || currentPage === 'admin-dashboard') renderApp();
                    }, (error) => {
                        console.error("Error fetching form status:", error);
                    });

                    // 2. Registrations Listener
                    unsubscribeRegistrations = onSnapshot(collection(db, PARTICIPANTS_COLLECTION_PATH), (snapshot) => {
                        // Prevent re-render from local cache, wait for server confirmation.
                        // This stops the UI from breaking during interaction (e.g. select dropdown closing).
                        if (snapshot.metadata.hasPendingWrites) {
                            return;
                        }
                        registrations = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            registrationDate: doc.data().registrationDate?.toDate().toLocaleString('id-ID') || 'N/A'
                        }));
                        if (currentPage === 'admin-dashboard') renderAdminDashboardContent();
                    }, (error) => {
                        console.error("Error fetching registrations:", error);
                        if (currentPage === 'admin-dashboard') setAdminError("Gagal memuat data pendaftar. Cek konsol untuk detail error izin.");
                    });
                }
                
                renderApp(); // Initial render after auth ready
            });
        }
        
        // Note: Global listeners removed to prevent timing issues

        // --- ADMIN ACTIONS ---
        
        const toggleFormStatus = async () => {
            if (!isFirebaseInitialized) {
                console.error("Mode UI-Only: Operasi database tidak dapat dilakukan.");
                return;
            }
            if (!isAuthReady) return;
            try {
                const settingsDocRef = doc(db, SETTINGS_COLLECTION_PATH, FORM_STATUS_DOC_ID);
                await updateDoc(settingsDocRef, {
                    isOpen: !isFormOpen,
                    lastUpdated: serverTimestamp()
                });
                setAdminError(null);
            } catch (error) {
                setAdminError(`Gagal mengubah status formulir. Error: ${error.message}`);
            }
        };

        const deleteRegistration = async (id, name) => {
            if (!isFirebaseInitialized) {
                console.error("Mode UI-Only: Operasi database tidak dapat dilakukan.");
                return;
            }
            if (!window.confirm(`Anda yakin ingin menghapus data pendaftar ${name}?`)) return;
            try {
                await deleteDoc(doc(db, PARTICIPANTS_COLLECTION_PATH, id));
                setAdminError(null);
            } catch (error) {
                setAdminError(`Gagal menghapus data pendaftar ${name}. Error: ${error.message}`);
            }
        };

        const updateRegistrationStatus = async (id, newStatus) => {
            if (!isFirebaseInitialized) {
                console.error("Mode UI-Only: Operasi database tidak dapat dilakukan.");
                return;
            }
            try {
                await updateDoc(doc(db, PARTICIPANTS_COLLECTION_PATH, id), {
                    status: newStatus,
                    verificationDate: serverTimestamp()
                });
                setAdminError(null);
            } catch (error) {
                setAdminError(`Gagal mengubah status pendaftar. Error: ${error.message}`);
            }
        };

        // --- RENDER FUNCTIONS ---

        const renderLandingPage = () => {
            document.getElementById('app-container').innerHTML = `
                <div class="flex flex-col min-h-screen bg-emerald-50 text-gray-800 relative">
                    <!-- Header -->
                    <header class="bg-emerald-600 text-white p-4 flex justify-between items-center shadow-md rounded-b-3xl sticky top-0 z-10">
                        <h1 class="font-bold text-lg tracking-wide">Jejak Petualang Siroh #7</h1>
                        <button onclick="navigate('admin-login')" class="p-2 hover:bg-emerald-700 rounded-full transition-colors" aria-label="Admin Login">
                            ${icon('Settings', 20)}
                        </button>
                    </header>

                    <!-- Main Content (Scrollable) -->
                    <main class="flex-grow p-6 flex flex-col items-center space-y-8 pb-8">
                        <!-- Peringatan Jika Firebase Tidak Diinisialisasi -->
                        ${!isFirebaseInitialized ? `
                            <div class="w-full bg-red-100 p-4 rounded-xl shadow-inner border border-red-300 space-y-2">
                                <h3 class="font-bold text-red-700 text-base flex items-center gap-2">
                                    ${icon('AlertTriangle', 20, 'text-red-600')} PERINGATAN!
                                </h3>
                                <p class="text-sm text-red-600">
                                    Aplikasi berjalan dalam mode **UI-Only** (tanpa database). Untuk menyimpan/memuat data, ganti konfigurasi *DUMMY* di skrip dengan kunci Firebase Project Anda yang sebenarnya.
                                </p>
                            </div>
                        ` : ''}

                        <!-- Hero Section - Title and Theme -->
                        <div class="text-center w-full">
                            <img src="https://blogger.googleusercontent.com/img/a/AVvXsEiSw6vPbF15ZAfLSGfTQ1v3PjMwBbwBi4m_PjQ4DkH2Dw46leE2EmlJZCvOtiZbmUFvKZ1zKuqbVSkzvI2NH0uvYg4JXf0h2fuhOy5RwJVPHNYHuw2ge5zhnS-lL-538U9St7akDLeuw4yKcQ7n31M2TEKRSnciZ4b8agm73_LKb73B9OPN34cUQZUSXpQ" alt="JPS #7 Poster" class="w-full h-56 object-cover rounded-3xl mb-6 shadow-lg border-4 border-white transform rotate-1 hover:rotate-0 transition-transform duration-500">
                            
                            <h2 class="text-3xl font-extrabold text-emerald-900 leading-tight mb-2">
                                Jejak Petualang <span class="text-emerald-500">Siroh #7</span>
                            </h2>
                            <h3 class="text-xl font-bold text-orange-600 leading-snug bg-orange-100/70 p-2 rounded-xl border border-orange-300">
                                Little Mujahid Khandaq: STRONG MIND, STRONG HEART
                            </h3>
                            <p class="text-gray-600 text-sm font-medium mt-3">
                                (Menyusuri Jejak Ketangguhan Sahabat di Perang Khandaq)
                            </p>
                        </div>
                        
                        <!-- Narrative Description -->
                        <div class="w-full bg-white p-5 rounded-3xl shadow-xl text-left space-y-4 border-b-4 border-emerald-300">
                            <p class="text-gray-700 font-bold">Liburan ini mau diisi dengan kegiatan apa?</p>
                            <p class="text-sm text-gray-600 leading-relaxed italic">
                                “Yuk, kita isi biar liburan lebih bermakna bareng @wonderful.siroh. Tema kegiatan Jejak Petualang Siroh kali ini adalah Little Mujahid Khandaq: STRONG MIND, STRONG HEART!”
                            </p>
                            <p class="text-sm text-gray-700 leading-relaxed">
                                Pada kegiatan kali ini, kita akan belajar tentang kisah hebat Perang Khandaq—saat para sahabat bersama Rasulullah ﷺ menunjukkan kekuatan luar biasa. Mereka tidak hanya kuat fisiknya saat menggali parit, tapi juga kuat hatinya dalam menjaga iman dan keberanian.
                            </p>
                            <p class="text-sm text-gray-700 leading-relaxed font-semibold">
                                Sebagai Little Mujahid, kita akan meneladani ketangguhan mereka: pantang menyerah, saling membantu, dan selalu percaya bahwa pertolongan Allah itu dekat. Walaupun kita masih kecil, kita juga bisa menjadi anak yang kuat pikiran dan hatinya. Kuat pikiran dengan terus belajar dan berusaha. Kuat hati dengan menjaga iman, berani berbuat benar, dan selalu menolong sesama.
                            </p>
                            <p class="text-sm text-emerald-600 font-bold mt-2">
                                Yuk, kita menyusuri jejak para sahabat dan bangun karakter kuat seperti mereka! Karena setiap langkah kecil keberanian kita hari ini akan menjadikan kita pahlawan tangguh di masa depan.
                            </p>
                        </div>
                        
                        <!-- Info Cards - Date, Time, Location -->
                        <div class="w-full grid grid-cols-1 gap-3">
                            <h3 class="font-bold text-emerald-800 text-lg mb-1">Informasi Waktu & Lokasi</h3>
                            <div class="bg-white p-4 rounded-2xl shadow-md border border-emerald-100 flex items-center gap-4">
                                <div class="bg-orange-100 p-3 rounded-full text-orange-600">${icon('Calendar', 24)}</div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Hari/Tanggal</h4>
                                    <p class="text-sm text-gray-500">Sabtu, 3 Januari 2026</p>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-md border border-emerald-100 flex items-center gap-4">
                                <div class="bg-blue-100 p-3 rounded-full text-blue-600">${icon('Clock', 24)}</div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Waktu</h4>
                                    <p class="text-sm text-gray-500">07.30 - 13.00 WIB</p>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-2xl shadow-md border border-emerald-100 flex items-center gap-4">
                                <div class="bg-red-100 p-3 rounded-full text-red-600">${icon('Map', 24)}</div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Tempat</h4>
                                    <p class="text-sm text-gray-500">Kampung Bamboo Jalan Terusan Padasuka KM 4, Cimenyan Bandung</p>
                                </div>
                            </div>
                        </div>

                        <!-- Activities and Facilities -->
                        <div class="w-full bg-white p-5 rounded-3xl shadow-xl space-y-6">
                            <h3 class="font-bold text-emerald-800 text-lg border-b pb-2">Aktivitas Utama</h3>
                            <div class="space-y-3">
                                <div class="flex items-start gap-3">
                                    ${icon('Users', 20, 'text-pink-500 mt-1 flex-shrink-0')}
                                    <div>
                                        <p class="font-bold text-gray-800">Berkisah Interaktif</p>
                                        <p class="text-sm text-gray-600">Kelas kecil bersama Abah Wahyu dan kelas besar bersama Kak Adi.</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    ${icon('Zap', 20, 'text-yellow-500 mt-1 flex-shrink-0')}
                                    <div>
                                        <p class="font-bold text-gray-800">Little Mujahid Outbound</p>
                                        <p class="text-sm text-gray-600">
                                            10 Permainan Seru: Flying Fox, Wall Climbing, Climbing Ground, Repling, Tubing, Army Zone, Water Game, Panahan, Burma Bridge, dan Tangkap Ikan.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 class="font-bold text-emerald-800 text-lg border-b pb-2 pt-4">Fasilitas</h3>
                            <ul class="text-sm text-gray-600 space-y-1 list-none p-0">
                                <li class="flex items-center gap-2 text-base">${icon('Circle-check-big', 16, 'text-green-500 flex-shrink-0')}1 Tiket peserta + 1 tiket pendamping</li>
                                <li class="flex items-center gap-2 text-base">${icon('Circle-check-big', 16, 'text-green-500 flex-shrink-0')}Makan siang (anak)</li>
                                <li class="flex items-center gap-2 text-base">${icon('Circle-check-big', 16, 'text-green-500 flex-shrink-0')}Doorprize</li>
                                <li class="flex items-center gap-2 text-base">${icon('Circle-check-big', 16, 'text-green-500 flex-shrink-0')}Link sertifikat & Link dokumentasi</li>
                                <li class="flex items-center gap-2 text-base">${icon('Circle-check-big', 16, 'text-green-500 flex-shrink-0')}Silaturahim dgn keluarga pecinta siroh</li>
                            </ul>
                        </div>
                        
                        <!-- Pricing and Age Recommendation -->
                        <div class="w-full bg-yellow-50 p-5 rounded-3xl shadow-xl space-y-4 border-2 border-yellow-300">
                            <h3 class="font-bold text-yellow-800 text-lg flex items-center gap-2">${icon('ticket-check', 20)} Harga Tiket Masuk (HTM)</h3>
                            <div class="space-y-1">
                                <p class="font-bold text-gray-800">HTM Normal:</p>
                                <p class="text-xl font-extrabold text-emerald-600">Rp 150.000</p>
                                <p class="text-sm font-semibold text-emerald-600">(1 Tiket anak + 1 pendamping)</p>
                            </div>
                            <p class="text-base font-semibold text-gray-700">HTM pendamping tambahan: <span class="text-red-500">Rp 20.000</span></p>
                            
                            <h3 class="font-bold text-yellow-800 text-lg flex items-center gap-2 mt-4">${icon('Users', 20)} Rekomendasi Usia</h3>
                            <p class="text-base text-gray-700 font-bold">4 - 8 tahun dan 9 - 12 tahun.</p>
                            <p class="text-sm text-gray-600">Jangan lupa ajak adik, kakak, saudara, dan teman lainnya ya!</p>
                        </div>

                        <!-- Warning Note -->
                        <div class="w-full bg-red-100 p-4 rounded-xl shadow-inner border border-red-300 mt-2">
                            <h3 class="font-bold text-red-700 text-base flex items-center gap-2">
                                ${icon('Triangle-Alert', 20, 'text-red-600')} Peringatan Penting
                            </h3>
                            <ul class="text-sm text-red-600 list-disc list-inside ml-2 space-y-1">
                                <li>Akses menuju lokasi acara cukup menanjak.</li>
                                <li>Pastikan kendaraan yang digunakan dalam kondisi baik dan cukup bahan bakar.</li>
                                <li>Diharapkan orang tua serta ananda menyiapkan fisik supaya fit pada hari H.</li>
                            </ul>
                        </div>
                    </main>

                    <!-- Floating Action Buttons (Sticky Bottom) - Alignment Fix -->
                    <div class="fixed bottom-0 w-full max-w-[512px] left-1/2 transform -translate-x-1/2 p-4 z-50">
                        <div class="flex gap-3">
                            <a 
                                href="https://wa.me/6281212338040" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                class="flex-1 bg-white border-2 border-emerald-600 text-emerald-700 hover:bg-emerald-50 font-bold py-3 px-2 rounded-xl shadow-sm active:scale-95 transition-all flex items-center justify-center gap-2 text-sm"
                            >
                                ${icon('Message-Circle-more', 18)}
                                Hubungi Admin
                            </a>
                            
                            ${isFormOpen ? `
                                <button onclick="navigate('register')" class="flex-[1.5] bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-2 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                                    ${icon('User-Plus', 18)}
                                    Daftar Sekarang
                                </button>
                            ` : `
                                <div class="flex-[1.5] bg-red-500 text-white font-bold py-3 px-2 rounded-xl shadow-lg flex items-center justify-center gap-2 text-sm select-none">
                                    ${icon('AlertTriangle', 18)}
                                    Pendaftaran Ditutup
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Footer -->
                    <footer class="bg-emerald-800 text-emerald-100 p-4 text-center text-xs font-semibold pt-2 pb-24">
                        &copy; 2025 Jejak Petualang Siroh.
                    </footer>
                </div>
            `;
            renderIcons(); // Panggil fungsi render ikon setelah HTML dimuat
        };

        // --- RENDER FORMULIR: MENGGUNAKAN GLOBAL STATE ---
        const renderRegistrationForm = () => { // Tidak ada argumen lagi
            if (!isFormOpen) {
                 document.getElementById('app-container').innerHTML = `
                    <div class="flex flex-col min-h-screen bg-red-50 text-gray-800 relative">
                        <header class="bg-red-600 text-white p-4 flex items-center shadow-md sticky top-0 z-10 rounded-b-3xl">
                            <button onclick="navigate('landing')" class="mr-4 hover:bg-red-700 p-2 rounded-full transition-colors">${icon('ArrowLeft', 24)}</button>
                            <h1 class="font-bold text-lg">Pendaftaran Ditutup</h1>
                        </header>
                        <div class="p-8 flex-grow flex flex-col items-center justify-center text-center space-y-6">
                            ${icon('AlertTriangle', 80, 'text-red-500')}
                            <h3 class="text-2xl font-bold text-red-700">Mohon Maaf</h3>
                            <p class="text-gray-600 font-medium max-w-xs">
                                Pendaftaran Jejak Petualang Siroh #7 sudah ditutup karena kuota sudah terpenuhi. Silakan hubungi admin untuk informasi *waiting list*.
                            </p>
                            <button onclick="navigate('landing')" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                ${icon('ArrowLeft', 18)} Kembali ke Beranda
                            </button>
                        </div>
                    </div>
                 `;
                 renderIcons();
                 return;
            }

            // MENGGUNAKAN GLOBAL STATE, BUKAN LOCAL VARIABLE
            // Ini kunci agar data tidak hilang saat refresh
            let formData = globalRegistrationFormData;

            let status = 'idle'; // 'idle', 'loading', 'success', 'error'
            let error = '';
            
            // --- HANDLER LOGIC DENGAN PEMBARUAN SELEKTIF (DIPINDAH KE ATAS) ---
            
            const handleFormChange = async (e) => {
                const { name, value, type, files, dataset } = e.target;
                
                let shouldUpdateContent = false;

                if (type === 'file' && e.target.id === 'proofOfTransferInput') {
                    const file = files[0];
                    if (file) {
                        if (file.size > MAX_FILE_SIZE_KB * 1024) { 
                            error = `Ukuran file terlalu besar (Maks. ${MAX_FILE_SIZE_KB}KB).`;
                            formData.proofOfTransfer = null;
                            formData.proofOfTransferDataUrl = null;
                        } else {
                            try {
                                formData.proofOfTransfer = file;
                                formData.proofOfTransferDataUrl = await fileToDataUrl(file);
                                error = '';
                            } catch (err) {
                                error = "Gagal membaca file bukti transfer.";
                                console.error("File reading error:", err);
                            }
                        }
                    } else {
                        formData.proofOfTransfer = null;
                        formData.proofOfTransferDataUrl = null;
                    }
                    shouldUpdateContent = true; // Perlu update info file
                } else if (name === 'numChildren') {
                    const newNum = parseInt(value) || 0;
                    const actualNum = Math.min(Math.max(1, newNum), 5);
                    
                    // Hanya update jika nilainya benar-benar berubah
                    if (formData.numChildren !== actualNum) {
                        formData.numChildren = actualNum;
                        const newChildrenData = Array.from({ length: actualNum }, (_, i) => {
                            return formData.childrenData[i] || { name: '', gender: 'Laki-laki', age: '' };
                        });
                        formData.childrenData = newChildrenData;
                        shouldUpdateContent = true; // Perlu update anak dan pembayaran
                    }
                } else if (name === 'numExtraCompanions' || name === 'numExtraLunch') {
                    formData[name] = parseInt(value) || 0;
                    shouldUpdateContent = true; // Perlu update rincian pembayaran
                } else if (dataset.field) {
                    const index = parseInt(dataset.index);
                    const field = dataset.field;
                    formData.childrenData[index] = { ...formData.childrenData[index], [field]: value };
                    // TIDAK perlu update content, biarkan input ini mempertahankan fokus
                } else {
                    formData[name] = value;
                    // TIDAK perlu update content untuk Nama Wali / WA
                }
                
                // Update Global State Explicitly (meskipun formData mereferensi global, ini untuk kejelasan)
                globalRegistrationFormData = formData;

                // Panggil fungsi update selektif hanya jika ada perubahan dinamis yang memerlukan re-render
                if (shouldUpdateContent) {
                    updateFormContent(); 
                }
            };
            
            const isFormValid = () => {
                if (!formData.guardianName.trim() || !formData.whatsappNumber.trim()) {
                    error = "Nama Wali dan Nomor WA Wali wajib diisi.";
                    return false;
                }
                if (!/^628\d{8,12}$/.test(formData.whatsappNumber)) {
                    error = "Nomor WhatsApp harus diawali '628' dan formatnya benar.";
                    return false;
                }
                if (formData.numChildren < 1 || formData.numChildren > 5) {
                    error = "Jumlah anak minimal 1 dan maksimal 5.";
                    return false;
                }
                for (let i = 0; i < formData.numChildren; i++) {
                    const child = formData.childrenData[i];
                    if (!child.name.trim() || !child.age || isNaN(parseInt(child.age)) || parseInt(child.age) < 4 || parseInt(child.age) > 12) {
                        error = `Data Anak ${i + 1} (Nama/Usia 4-12) wajib diisi dengan benar.`;
                        return false;
                    }
                }
                if (!formData.proofOfTransfer) {
                    error = "Mohon upload Bukti Transfer terlebih dahulu.";
                    return false;
                }
                error = '';
                return true;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isFormOpen) {
                    error = "Pendaftaran telah ditutup saat Anda mengisi formulir.";
                    updateFormContent();
                    return;
                }
                if (!isFormValid()) {
                    updateFormContent(); // Tampilkan error
                    return;
                }
                if (!isAuthReady) {
                    error = "Sistem belum siap. Coba lagi sebentar.";
                    updateFormContent(); // Tampilkan error
                    return;
                }
                
                status = 'loading';
                updateFormContent(); // Ubah tombol submit menjadi loading
                
                if (!isFirebaseInitialized) {
                     console.error("Mode UI-Only: Pendaftaran berhasil di sisi UI, tetapi data TIDAK disimpan ke database. Untuk menyimpan, inisialisasi Firebase dengan benar.");
                     status = 'success';
                     resetGlobalFormData(); // Reset form jika sukses
                     navigate('register-success');
                     return;
                }

                const dataToSave = {
                    guardianName: formData.guardianName,
                    whatsappNumber: formData.whatsappNumber,
                    numChildren: formData.numChildren,
                    numExtraCompanions: formData.numExtraCompanions,
                    numExtraLunch: formData.numExtraLunch,
                    totalPayment: formData.numChildren * BASE_TICKET_PRICE + formData.numExtraCompanions * EXTRA_COMPANION_PRICE + formData.numExtraLunch * EXTRA_LUNCH_PRICE,
                    childrenData: formData.childrenData.slice(0, formData.numChildren).map(child => ({
                        name: child.name, age: Number(child.age), gender: child.gender
                    })),
                    proofOfTransferFileName: formData.proofOfTransfer ? formData.proofOfTransfer.name : 'N/A', 
                    proofOfTransferDataUrl: formData.proofOfTransferDataUrl,
                    registrationDate: serverTimestamp(),
                    registeredByUid: currentUser?.uid || 'anonymous',
                    activity: "Jejak Petualang Siroh #7",
                    status: "Menunggu Verifikasi Pembayaran",
                };

                try {
                    await addDoc(collection(db, PARTICIPANTS_COLLECTION_PATH), dataToSave);
                    status = 'success';
                    resetGlobalFormData(); // Reset form data setelah sukses terkirim
                    navigate('register-success');
                } catch (err) {
                    console.error("Error saving participant data: ", err);
                    error = "Gagal menyimpan data ke database. Silakan coba lagi.";
                    status = 'error';
                    updateFormContent(); // Tampilkan error dan kembalikan tombol
                }
            };

            // --- FUNGSI RENDER PARSIAL BARU ---
            const renderChildInputs = (formData) => {
                return Array.from({ length: formData.numChildren }).map((_, index) => {
                    const child = formData.childrenData[index] || { name: '', gender: 'Laki-laki', age: '' };
                    return `
                        <div class="space-y-3 p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <h3 class="font-bold text-base text-emerald-700">Anak #${index + 1}</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Anak ${index + 1} *</label>
                                <input type="text" data-index="${index}" data-field="name" value="${child.name}" 
                                    class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none" placeholder="Nama Anak ${index + 1}" />
                            </div>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Usia Anak ${index + 1} (4-12) *</label>
                                    <input type="number" data-index="${index}" data-field="age" value="${child.age}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none" min="4" max="12" />
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin *</label>
                                    <select data-index="${index}" data-field="gender" value="${child.gender}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none bg-white">
                                        <option value="Laki-laki" ${child.gender === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                                        <option value="Perempuan" ${child.gender === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            };

            const renderPaymentDetails = (formData, totalPayment) => {
                return `
                    <div class="p-4 bg-yellow-100 rounded-3xl shadow-inner border border-yellow-300 space-y-3">
                        <h2 class="text-xl font-bold text-yellow-800 border-b pb-2 mb-2 flex items-center gap-2">${icon('FileText', 20)} Rincian Pembayaran</h2>
                        
                        <div class="text-sm space-y-1">
                            <div class="flex justify-between text-gray-700">
                                <span>Tiket Peserta (${formData.numChildren} x ${formatRupiah(BASE_TICKET_PRICE)})</span>
                                <span class="font-semibold">${formatRupiah(formData.numChildren * BASE_TICKET_PRICE)}</span>
                            </div>
                            <div class="flex justify-between text-gray-700">
                                <span>Pendamping Tambahan (${formData.numExtraCompanions} x ${formatRupiah(EXTRA_COMPANION_PRICE)})</span>
                                <span class="font-semibold">${formatRupiah(formData.numExtraCompanions * EXTRA_COMPANION_PRICE)}</span>
                            </div>
                            <div class="flex justify-between text-gray-700">
                                <span>Makan Siang Tambahan (${formData.numExtraLunch} x ${formatRupiah(EXTRA_LUNCH_PRICE)})</span>
                                <span class="font-semibold">${formatRupiah(formData.numExtraLunch * EXTRA_LUNCH_PRICE)}</span>
                            </div>
                        </div>

                        <div class="pt-2 border-t border-yellow-400">
                            <div class="flex justify-between text-lg font-extrabold text-red-600">
                                <span>TOTAL PEMBAYARAN:</span>
                                <span>${formatRupiah(totalPayment)}</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // --- FUNGSI UPDATE UTAMA (Hanya Mengganti Konten Tertentu) ---
            const updateFormContent = () => {
                const totalPayment = formData.numChildren * BASE_TICKET_PRICE + 
                                     formData.numExtraCompanions * EXTRA_COMPANION_PRICE + 
                                     formData.numExtraLunch * EXTRA_LUNCH_PRICE;
                
                // 1. Update Data Anak
                const childrenContainer = document.getElementById('children-inputs-container');
                if (childrenContainer) {
                    childrenContainer.innerHTML = renderChildInputs(formData);
                }

                // 2. Update Rincian Pembayaran
                const paymentContainer = document.getElementById('payment-details-container');
                if (paymentContainer) {
                    paymentContainer.innerHTML = renderPaymentDetails(formData, totalPayment);
                }
                
                // 3. Update Error Message
                const errorDisplay = document.getElementById('form-error-display');
                if (errorDisplay) {
                    errorDisplay.textContent = error;
                    errorDisplay.style.display = error ? 'block' : 'none';
                }

                // 4. Update File Info
                const fileInfo = document.getElementById('proof-file-info');
                if (fileInfo) {
                    fileInfo.innerHTML = formData.proofOfTransfer ? `
                        <p class="text-sm text-gray-600 mt-2">File terpilih: <span class="font-bold">${formData.proofOfTransfer.name}</span></p>
                    ` : '';
                }

                // 5. Update Submit Button Status (jika ada loading)
                const submitButton = document.getElementById('submit-button');
                if (submitButton) {
                    submitButton.disabled = status === 'loading';
                    submitButton.className = `w-full text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2 ${
                        status === 'loading' 
                            ? 'bg-gray-400 cursor-not-allowed' 
                            : 'bg-emerald-600 hover:bg-emerald-500 shadow-[0_4px_0_rgb(6,95,70)] active:shadow-none active:translate-y-1'
                    }`;
                    submitButton.innerHTML = status === 'loading' ? `${icon('Loader2', 20, 'animate-spin')} Mengirim Data...` : `${icon('Send', 20)} Kirim Pendaftaran`;
                }

                renderIcons(); // Render ulang ikon hanya pada area yang diubah
            };

            // --- STRUKTUR HTML UTAMA FORMULIR ---

            const totalPaymentInitial = formData.numChildren * BASE_TICKET_PRICE + 
                                        formData.numExtraCompanions * EXTRA_COMPANION_PRICE + 
                                        formData.numExtraLunch * EXTRA_LUNCH_PRICE;

            const html = `
                <div class="flex flex-col min-h-screen bg-white text-gray-800 relative">
                    <header class="bg-emerald-600 text-white p-4 flex items-center shadow-md sticky top-0 z-10 rounded-b-3xl">
                        <button onclick="navigate('landing')" class="mr-4 hover:bg-emerald-700 p-2 rounded-full transition-colors">${icon('undo-2', 24)}</button>
                        <h1 class="font-bold text-lg">Formulir Pendaftaran JPS #7</h1>
                    </header>
                    
                    <main class="p-6 flex-grow">
                        <p class="text-sm text-gray-500 mb-6 text-center font-medium">Lengkapi data wali dan peserta untuk memproses pendaftaran.</p>

                        <form id="registration-form" class="space-y-6 bg-emerald-50 p-6 rounded-3xl shadow-lg">
                            
                            <!-- 1. Data Wali -->
                            <div class="space-y-4 p-4 border border-dashed border-emerald-300 rounded-xl bg-white">
                                <h2 class="text-xl font-bold text-emerald-800 border-b pb-2 mb-4 flex items-center gap-2">${icon('Users', 20)} Data Wali</h2>
                                
                                <div>
                                    <label for="guardianName" class="block text-sm font-bold text-gray-700 mb-1">Nama Orang Tua/Wali *</label>
                                    <input id="guardianName" type="text" name="guardianName" value="${formData.guardianName}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors" placeholder="Contoh: Gina Arina" required />
                                </div>

                                <div>
                                    <label for="whatsappNumber" class="block text-sm font-bold text-gray-700 mb-1">Nomor WhatsApp Wali (Diawali 628) *</label>
                                    <input id="whatsappNumber" type="tel" name="whatsappNumber" value="${formData.whatsappNumber}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors" placeholder="Contoh: 6281212338040" maxlength="15" required />
                                </div>

                                <div>
                                    <label for="numChildren" class="block text-sm font-bold text-gray-700 mb-1">Jumlah Anak Yang Akan Didaftarkan (1-5) *</label>
                                    <input id="numChildren" type="number" name="numChildren" value="${formData.numChildren}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors" min="1" max="5" required />
                                </div>
                            </div>

                            <!-- 2. Data Anak (Dynamic) - ID TARGET BARU -->
                            <div class="space-y-4 p-4 border border-dashed border-emerald-300 rounded-xl bg-white">
                                <h2 class="text-xl font-bold text-emerald-800 border-b pb-2 mb-4 flex items-center gap-2">${icon('User-Plus', 20)} Data Peserta</h2>
                                <div id="children-inputs-container">
                                    ${renderChildInputs(formData)}
                                </div>
                            </div>

                            <!-- 3. Data Tambahan -->
                            <div class="space-y-4 p-4 border border-dashed border-emerald-300 rounded-xl bg-white">
                                <h2 class="text-xl font-bold text-emerald-800 border-b pb-2 mb-4 flex items-center gap-2">${icon('ticket-plus', 20)} Tambahan</h2>

                                <div>
                                    <label for="numExtraCompanions" class="block text-sm font-bold text-gray-700 mb-1">Jumlah Pendamping Tambahan (@Rp ${formatRupiah(EXTRA_COMPANION_PRICE)})</label>
                                    <input id="numExtraCompanions" type="number" name="numExtraCompanions" value="${formData.numExtraCompanions}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors" min="0" />
                                    <p class="text-xs text-gray-500 mt-1">Setiap peserta sudah termasuk 1 pendamping gratis.</p>
                                </div>
                                
                                <div>
                                    <label for="numExtraLunch" class="block text-sm font-bold text-gray-700 mb-1">Pesan Makan Siang Pendamping (@Rp ${formatRupiah(EXTRA_LUNCH_PRICE)})</label>
                                    <input id="numExtraLunch" type="number" name="numExtraLunch" value="${formData.numExtraLunch}"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors" min="0" />
                                    <p class="text-xs text-gray-500 mt-1">Nasi timbel/liwet + ayam + tempe/ikan asin + sambal lalap + teh tawar/air mineral.</p>
                                </div>
                            </div>

                            <!-- 4. Rincian Pembayaran - ID TARGET BARU -->
                            <div id="payment-details-container">
                                ${renderPaymentDetails(formData, totalPaymentInitial)}
                            </div>
                            
                            <!-- 5. Info Pembayaran dan Cancel Policy (Tidak berubah) -->
                            <div class="p-4 bg-white rounded-3xl shadow-sm border border-gray-200 space-y-4">
                                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2 flex items-center gap-2">${icon('Dollar-Sign', 20)} Info Pembayaran</h2>
                                <div class="text-sm">
                                    <p class="font-bold">Transfer ke:</p>
                                    <p>Bank BCA: <span class="text-emerald-600 font-extrabold">2831400899</span></p>
                                    <p>a.n. <span class="font-bold">Gina Arina</span></p>
                                    <p class="mt-2">CP: Inas <span class="font-bold text-emerald-600">081212338040</span></p>
                                </div>

                                <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-2 flex items-center gap-2">${icon('Triangle-alert', 20)} Ketentuan Cancel</h2>
                                <ul class="text-sm text-gray-600 list-decimal list-inside ml-2 space-y-1">
                                    <li>Tidak menerima pembatalan peserta. Jika peserta batal, dipersilakan mencari pengganti atau dapat digantikan dgn peserta Waiting List JPS#7 (silakan hubungi admin untuk info WL).</li>
                                    <li>Jika tidak ada peserta pengganti dari WL, tidak dapat *refund*.</li>
                                </ul>
                            </div>

                            <!-- 6. Bukti Transfer -->
                            <div class="space-y-4 p-4 border border-dashed border-emerald-300 rounded-xl bg-white">
                                <h2 class="text-xl font-bold text-emerald-800 border-b pb-2 mb-4 flex items-center gap-2">${icon('folder-up', 20)} Bukti Transfer (${MAX_FILE_SIZE_KB}KB Max) *</h2>
                                
                                <label class="block w-full p-2 text-sm text-center text-emerald-700 bg-emerald-200 rounded-full hover:bg-emerald-300 cursor-pointer">
                                    <span>Pilih File Bukti Transfer</span>
                                    <input id="proofOfTransferInput" type="file" accept="image/*, application/pdf" required class="hidden" />
                                </label>
                                <div id="proof-file-info">
                                    ${formData.proofOfTransfer ? `
                                        <p class="text-sm text-gray-600 mt-2">File terpilih: <span class="font-bold">${formData.proofOfTransfer.name}</span></p>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Error Message -->
                            <div id="form-error-display" class="p-3 bg-red-100 border border-red-300 text-red-600 rounded-xl text-sm font-bold text-center" style="${error ? '' : 'display: none;'}">
                                ${error}
                            </div>
                            
                            <!-- Submit Button -->
                            <button type="submit" id="submit-button" ${status === 'loading' ? 'disabled' : ''}
                                class="w-full text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2 
                                ${status === 'loading' ? 'bg-gray-400 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-500 shadow-[0_4px_0_rgb(6,95,70)] active:shadow-none active:translate-y-1'}">
                                ${status === 'loading' ? `${icon('Loader', 20, 'animate-spin')} Mengirim Data...` : `${icon('Send', 20)} Kirim Pendaftaran`}
                            </button>
                        </form>
                    </main>
                </div>
            `;
            document.getElementById('app-container').innerHTML = html;
            renderIcons();

            // Attach event listeners (Delegasi Event)
            const formElement = document.getElementById('registration-form');
            if (formElement) {
                formElement.addEventListener('change', handleFormChange);
                formElement.addEventListener('input', handleFormChange);
                formElement.addEventListener('submit', handleSubmit);
            }
        };

        const renderSuccessPage = () => {
            document.getElementById('app-container').innerHTML = `
                <div class="flex flex-col min-h-screen bg-emerald-50 text-gray-800 relative">
                    <header class="bg-emerald-600 text-white p-4 flex items-center shadow-md sticky top-0 z-10 rounded-b-3xl">
                        <h1 class="font-bold text-lg mx-auto">Pendaftaran Berhasil</h1>
                    </header>
                    <div class="p-8 flex-grow flex flex-col items-center justify-center text-center space-y-6">
                        ${icon('Circle-check-big2', 80, 'text-emerald-500')}
                        <h2 class="text-3xl font-extrabold text-emerald-900">Terima Kasih!</h2>
                        <p class="text-gray-600 font-medium max-w-sm">
                            Pendaftaran Anda telah kami terima. Informasi selanjutnya akan diumumkan melalui Grup WhatsApp.
                        </p>
                        
                        <div class="w-full max-w-xs space-y-4 pt-4">
                            <a href="https://chat.whatsapp.com/LW6Z6liGnKGAkDLfbYOTw6" id="whatsapp-join-link" target="_blank" rel="noopener noreferrer" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                ${icon('MessageCircle', 18)} Gabung Grup WhatsApp
                            </a>
                            <button onclick="navigate('landing')" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                ${icon('ArrowLeft', 18)} Kembali ke Beranda
                            </button>
                        </div>

                        <p class="text-xs text-gray-400 pt-8">
                            Jika Anda tidak segera bergabung ke grup, Anda mungkin akan ketinggalan informasi penting.
                        </p>
                    </div>
                </div>
            `;
            renderIcons();
        };

        const renderAdminLogin = () => {
            document.getElementById('app-container').innerHTML = `
                <div class="flex flex-col min-h-screen bg-gray-100 text-gray-800 relative">
                    <header class="bg-gray-800 text-white p-4 flex items-center shadow-md rounded-b-3xl">
                        <button onclick="navigate('landing')" class="mr-4 hover:bg-gray-700 p-2 rounded-full transition-colors">${icon('ArrowLeft', 24)}</button>
                        <h1 class="font-bold text-lg">Login Admin</h1>
                    </header>
                    
                    <div class="p-8 flex flex-col justify-center flex-grow">
                        <div class="bg-white p-8 rounded-3xl shadow-lg border-2 border-gray-100">
                            <h2 class="text-xl font-bold mb-6 text-center text-gray-700">Masuk Panel Admin</h2>
                            <form id="login-form" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-bold text-gray-600 mb-2">Password</label>
                                    <input type="password" id="admin-password"
                                        class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors"
                                        placeholder="Masukkan password" />
                                </div>
                                <p id="login-error" class="text-red-500 text-sm font-bold text-center bg-red-50 p-2 rounded-lg" style="display: none;"></p>
                                <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-700 shadow-lg transform active:scale-95 transition-all">
                                    Masuk
                                </button>
                                <button type="button" onclick="navigate('landing')" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl hover:bg-gray-300 shadow-sm transform active:scale-95 transition-all">
                                    Batal
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            renderIcons();

            // Mengembalikan logika login statis (Anonymous user + Password 123456)
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('admin-password').value;
                const errorElement = document.getElementById('login-error');
                if (password === '123456') {
                    navigate('admin-dashboard');
                } else {
                    errorElement.textContent = 'Password salah!';
                    errorElement.style.display = 'block';
                }
            });
        };

        const renderAdminDashboard = () => {
            // Cek status otentikasi saat ini
            const currentUserId = currentUser?.uid || 'N/A';
            
            document.getElementById('app-container').innerHTML = `
                <div class="flex flex-col min-h-screen bg-gray-50 text-gray-800 relative">
                    <header class="bg-indigo-600 text-white p-4 flex justify-between items-center shadow-md rounded-b-3xl sticky top-0 z-10">
                        <h1 class="font-bold text-lg">Admin Panel JPS #7</h1>
                        <div class="flex items-center space-x-3">
                            <!-- Toggle component for Form Status -->
                            <div id="form-toggle-container" class="flex items-center p-2 rounded-full space-x-2 transition-colors duration-300">
                                <!-- Konten Toggle dimuat di renderAdminDashboardContent -->
                            </div>

                            <button onclick="navigate('landing')" class="text-xs font-bold bg-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                Logout
                            </button>
                        </div>
                    </header>
                    
                    <main class="p-6 flex-grow space-y-8">
                        <h2 class="text-xl font-bold text-indigo-700 border-b pb-2 mb-4">Statistik Pendaftaran</h2>
                        
                        <!-- Display Temporary Admin Action Error -->
                        <div id="admin-error-display"></div>
                        
                        <!-- Peringatan Jika Firebase Tidak Diinisialisasi -->
                        ${!isFirebaseInitialized ? `
                            <div class="w-full bg-red-100 p-4 rounded-xl shadow-inner border border-red-300 space-y-2 mb-4">
                                <h3 class="font-bold text-red-700 text-base flex items-center gap-2">
                                    ${icon('AlertTriangle', 20, 'text-red-600')} MODE UI-ONLY AKTIF
                                </h3>
                                <p class="text-sm text-red-600">
                                    Operasi database (baca/tulis/hapus) dinonaktifkan. Data yang ditampilkan adalah data tiruan atau data yang tersisa dari sesi sebelumnya.
                                </p>
                            </div>
                        ` : ''}

                        <!-- Statistics Grid and Registration List will be loaded here -->
                        <div id="dashboard-content">
                            <div class="text-center p-10 bg-white rounded-xl shadow-md">
                                ${icon('Loader2', 32, 'animate-spin text-indigo-500 mx-auto')}
                                <p class="mt-4 text-gray-600">${isFirebaseInitialized ? 'Memuat data dari Firebase...' : 'Database tidak terhubung.'}</p>
                            </div>
                        </div>

                        <!-- User ID Debug -->
                        <div class="text-xs text-gray-400 text-center pt-8">
                            User ID: ${currentUserId} (Anonymous Admin Mode)
                        </div>
                    </main>
                </div>
            `;
            renderIcons();
            renderAdminDashboardContent(); // Panggil fungsi untuk mengisi konten dashboard
        };

        const renderAdminDashboardContent = () => {
            if (currentPage !== 'admin-dashboard') return;

            const dashboardContent = document.getElementById('dashboard-content');
            const toggleContainer = document.getElementById('form-toggle-container');
            if (!dashboardContent || !toggleContainer) return;

            // --- RENDER TOGGLE ---
            const toggleColor = isFormOpen ? 'bg-emerald-700' : 'bg-red-700';
            toggleContainer.className = `flex items-center p-2 rounded-full space-x-2 transition-colors duration-300 ${toggleColor}`;
            toggleContainer.innerHTML = `
                <span class="text-xs font-semibold">${isFormOpen ? 'FORM OPEN' : 'FORM CLOSED'}</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" ${isFormOpen ? 'checked' : ''} onclick="toggleFormStatus()" class="sr-only peer" />
                    <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
                </label>
            `;
            
            // --- RENDER STATISTIK ---
            const totalChildren = registrations.reduce((sum, reg) => sum + (reg.numChildren || 0), 0);
            const totalCompanions = registrations.reduce((sum, reg) => sum + (reg.numChildren || 0) + (reg.numExtraCompanions || 0), 0);
            const totalExtraLunch = registrations.reduce((sum, reg) => sum + (reg.numExtraLunch || 0), 0);
            const totalRevenue = registrations.reduce((sum, reg) => sum + (reg.totalPayment || 0), 0);
            const maleParticipants = registrations.flatMap(reg => reg.childrenData || []).filter(child => child.gender === 'Laki-laki').length;
            const femaleParticipants = registrations.flatMap(reg => reg.childrenData || []).filter(child => child.gender === 'Perempuan').length;

            const StatCard = (title, value, iconName, color) => `
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-${color}-500 flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500">${title}</p>
                        <p class="text-2xl font-bold text-gray-800 mt-1">${typeof value === 'number' ? formatRupiah(value) : value}</p>
                    </div>
                    ${icon(iconName, 32, `text-${color}-500 opacity-60`)}
                </div>
            `;

            let registrationListHTML = '';
            if (registrations.length === 0) {
                registrationListHTML = `<div class="p-4 bg-yellow-100 rounded-xl text-yellow-800 text-center font-semibold">Belum ada pendaftar yang masuk.</div>`;
            } else {
                registrationListHTML = registrations.map(reg => {
                    const statusColor = reg.status === 'Terverifikasi' ? 'text-green-600 bg-green-50'
                                    : reg.status === 'Dibatalkan/Gagal' ? 'text-red-600 bg-red-50'
                                    : 'text-orange-600 bg-orange-50';

                    const childrenList = (reg.childrenData || []).map((child, index) => `
                        <div class="flex justify-between text-sm bg-indigo-50 p-3 rounded-lg">
                            <span class="font-semibold text-gray-700">Anak ${index + 1}: ${child.name}</span>
                            <span class="text-gray-500">(${child.gender}, ${child.age} thn)</span>
                        </div>
                    `).join('');

                    return `
                        <div class="bg-white p-5 rounded-xl shadow-lg border border-indigo-100 space-y-4">
                            <div class="flex justify-between items-center border-b pb-2 mb-3">
                                <h3 class="text-lg font-bold text-indigo-700 flex items-center gap-2">${icon('User', 20)} ${reg.guardianName}</h3>
                                <div class="flex items-center space-x-2">
                                    <p class="text-xs text-gray-500">${reg.registrationDate}</p>
                                    
                                    <button onclick="deleteRegistration('${reg.id}', '${reg.guardianName}')" 
                                        class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors" title="Hapus Pendaftar Ini">
                                        ${icon('Trash2', 20)}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-sm space-y-1">
                                <p class="text-gray-600 font-semibold">WA Wali: <span class="text-emerald-600">${reg.whatsappNumber}</span></p>
                            </div>

                            <div class="space-y-2 border-t pt-3">
                                <p class="font-bold text-gray-800">Peserta Anak (${reg.numChildren} Orang):</p>
                                ${childrenList}
                            </div>

                            <div class="text-sm border-t pt-3">
                                <p class="font-bold text-gray-800">Total Transfer: <span class="text-indigo-600 text-lg font-extrabold">${formatRupiah(reg.totalPayment)}</span></p>
                                
                                <div class="mt-2 flex justify-between items-center">
                                    <p>Bukti Transfer: 
                                        <span class="font-semibold ml-2 ${reg.proofOfTransferDataUrl ? 'text-green-600' : 'text-orange-500'}">
                                            ${reg.proofOfTransferFileName || 'Belum Ada'}
                                        </span>
                                    </p>
                                    
                                    ${reg.proofOfTransferDataUrl ? `
                                        <button onclick="showProofModal('${reg.proofOfTransferDataUrl}', '${reg.proofOfTransferFileName}')"
                                            class="text-indigo-500 text-xs font-bold py-1 px-3 rounded-full bg-indigo-50 hover:bg-indigo-100 transition-colors shadow-sm">
                                            Tampilkan Bukti
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <!-- Status Update Dropdown -->
                                <div class="mt-3 p-2 rounded-lg border flex justify-between items-center ${statusColor}">
                                    <span class="font-bold text-sm">Status:</span>
                                    <select onchange="updateRegistrationStatus('${reg.id}', this.value)"
                                        class="font-semibold text-sm border-none rounded-md p-1 ${statusColor} bg-transparent outline-none cursor-pointer">
                                        <option value="Menunggu Verifikasi Pembayaran" ${reg.status === 'Menunggu Verifikasi Pembayaran' ? 'selected' : ''}>Menunggu Verifikasi Pembayaran</option>
                                        <option value="Terverifikasi" ${reg.status === 'Terverifikasi' ? 'selected' : ''}>Terverifikasi</option>
                                        <option value="Dibatalkan/Gagal" ${reg.status === 'Dibatalkan/Gagal' ? 'selected' : ''}>Dibatalkan/Gagal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            dashboardContent.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    ${StatCard("Total Anak", totalChildren, "UserPlus", "blue")}
                    ${StatCard("Total Pendamping", totalCompanions, "Users", "green")}
                    ${StatCard("Makan Siang Tambahan", totalExtraLunch, "Clock", "orange")}
                    ${StatCard("Laki-laki/Perempuan", `${maleParticipants} / ${femaleParticipants}`, "Heart", "pink")}
                </div>
                
                ${StatCard("Total Dana Terkumpul", totalRevenue, "TrendingUp", "indigo")}

                <h2 class="text-xl font-bold text-indigo-700 border-b pb-2 mb-4 pt-4">Data Pendaftar (${registrations.length} Transaksi)</h2>

                <div class="space-y-4">
                    ${registrationListHTML}
                </div>
            `;
            
            renderIcons(); // Panggil fungsi render ikon setelah HTML dimuat
            // Pastikan error display terupdate jika ada error yang tertinggal
            setAdminError(tempAdminError); 
        };

        // --- MODAL (Untuk Tampilan Bukti Transfer) ---

        const showProofModal = (dataUrl, fileName) => {
            const modalHTML = `
                <div id="proof-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto">
                        <div class="p-4 border-b flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-800">Bukti Transfer: ${fileName}</h3>
                            <button onclick="document.getElementById('proof-modal').remove()" class="text-gray-500 hover:text-gray-800">
                                ${icon('X', 24)}
                            </button>
                        </div>
                        <div class="p-4 text-center">
                            <img src="${dataUrl}" alt="Bukti Transfer" class="w-full h-auto object-contain rounded-lg shadow-md" 
                                onerror="this.onerror=null; this.src='https://placehold.co/400x400/f97316/ffffff?text=Gagal+Memuat+Gambar';" />
                            <p class="text-xs text-gray-500 mt-3 truncate">${fileName}</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            renderIcons();
        };

        // --- MAIN APPLICATION RENDER ---

        const renderApp = () => {
            if (!isAuthReady) {
                document.getElementById('app-container').innerHTML = `
                    <div class="flex flex-col min-h-screen items-center justify-center bg-gray-50 text-gray-600">
                        ${icon('Loader2', 32, 'animate-spin text-emerald-500')}
                        <p class="mt-4">Memuat aplikasi...</p>
                    </div>
                `;
                renderIcons();
                return;
            }

            switch (currentPage) {
                case 'landing':
                    renderLandingPage();
                    break;
                case 'register':
                    renderRegistrationForm(); // PERBAIKAN: Tidak perlu mengirim objek kosong lagi
                    break;
                case 'register-success':
                    renderSuccessPage();
                    break;
                case 'admin-login':
                    renderAdminLogin();
                    break;
                case 'admin-dashboard':
                    renderAdminDashboard();
                    break;
                default:
                    navigate('landing');
            }
        };

        // Ekspos fungsi ke scope global agar bisa dipanggil dari onclick
        window.navigate = navigate;
        window.toggleFormStatus = toggleFormStatus;
        window.deleteRegistration = deleteRegistration;
        window.updateRegistrationStatus = updateRegistrationStatus;
        window.showProofModal = showProofModal;

        // Mulai aplikasi
        window.onload = renderApp;
    </script>
</body>
</html>




